<!doctype html>
<html lang=en>
<meta charset=utf-8>
<title>ESPP taxation simulator</title>
<style type="text/css">
body {
	max-width: 1100px;
	margin: 0 auto;
	padding: 0 1em;
	font-family: sans-serif;
}
#timeline {
	height: 5em;
	width: 100%;
	max-width: 1000px;
	margin: 2em auto 0;
	caption-side: bottom;
	text-align: center;
}
table {
	border-collapse: collapse;
}
th, td {
	border: 1px solid black;
	padding: .2em .4em;
}
#offering_period {
	background-color: gray;
	width: 10%;
}
#stcg {
	background-color: red;
	width: 40%;
}
#ltcg {
	background-color: green;
	width: 30%;
}
#qualdist {
	background-color: blue;
	width: 20%;
	border-right-style: dashed;
}
form {
	display: table;
}
form p {
	display: table-row;
}
form div {
	display: table-cell;
	padding: .1em 0;
}
form div + div {
	padding-left: 1em;
}
.loss {
	color: red;
}
</style>
<body>
<h1>ESPP taxation simulator</h1>
<form>
<p><div><input type="checkbox" id="lookback" name="lookback"></div><div><label for="lookback">Lookback provision (the discount applies to the price at the start of the offering period or the price at the end, whichever is lower)</label></div>
<p><div><input type="number" id="offlen" name="offlen" min="1" max="27" value="3"></div><div><label for="offlen">Length of the offering period in months</label></div>
<p><div><input type="number" id="discount" name="discount" min="0" max="15" value="15">%</div><div><label for="discount">Discount you receive on the stock</label></div>
<p><div>$<input type="number" id="price1" name="price1" min="0" max="100000" value="100"></div><div><label for="price1">Stock price (market value) at the <strong>beginning</strong> of the offering period</label></div>
<p><div>$<input type="number" id="price2" name="price2" min="0" max="100000" value="110"></div><div><label for="price2">Stock price (market value) at the <strong>end</strong> of the offering period</label></div>
<p><div>$<input type="number" id="saleprice" name="saleprice" min="0" max="100000" value="110"></div><div><label for="saleprice">Sale price</label> (<input type="checkbox" id="lock" name="lock"> <label for="lock">Sell immediately - lock to ending price</label>)</div>
</form>

<table id="timeline"><caption>ESPP timeline</caption><tr>
<td id="offering_period">Offering period (<span id="off_timeline_len">3 months</span>)</td>
<td id="stcg">Disqualifying disposition; short-term capital gain (1 year)</td>
<td id="ltcg">Disqualifying disposition; long-term capital gain (<span id="ltcg_timeline_len">9 months</span>)</td>
<td id="qualdist">Qualifying disposition (&infin;)</td>
</tr></table>

<h2>Results</h2>
<p>You acquire your shares for <strong id="ord1">$93.50</strong> each. This is always taxed as <strong>ordinary income</strong> and is withheld from your paychecks as you contribute money throughout the offering period. You pay this tax the year of the offering period.

<table id="results">
<tr><th></th><th>STCG</th><th>LTCG; disqualifying disposition</th><th>Qualifying disposition</th></tr>
<tr><td></td><td>You sell within 1 year of receiving the shares</td><td id="ltcg_desc">You sell between 1 year and <span id="ltcg_timeline_len">21 months</span> after receiving the shares</td><td>You sell more than <span id="disq_len">21 months</span> after receiving the shares</td></tr>
<tr><td>Ordinary income at time of sale</td><td id="stcg_ord2">$16.50</td><td id="ltcg_ord2">$16.50</td><td id="qual_ord2">$15.00</td></tr>
<tr><td>Total ordinary income</td><td id="stcg_ord">$110.00</td><td id="ltcg_ord">$110.00</td><td id="qual_ord">$108.50</td></tr>
<tr><td>Capital gain/loss</td><td><span id="stcg_cg">$0.00</span> (short-term)</td><td><span id="ltcg_cg_outer"><span id="ltcg_cg">$0.00</span> (long-term)</span></td><td><span id="qual_cg">$1.50</span> (long-term)</td></tr>
</table>

<script type="text/javascript">
function dispmoney(val) {
	absval = "$" + Math.abs(val).toFixed(2);
	if (val >= 0)
		return absval;
	else
		return '<span class="loss">(' + absval + ')</span>';
}
function disp_months(val) {
	if (val === 1)
		return "1 month";
	if (val === 12)
		return "1 year";
	if (val !== 0 && val % 12 === 0)
		return (val / 12) + " years";
	return val + " months";
}

var $ = document.getElementById.bind(document);
function calculate(lookback, offlen, discount, price1, price2, saleprice) {
	let acq_price = (1 - discount) * (lookback ? Math.min(price1, price2) : price2);
	let disq_discount = price2 - acq_price;
	let disq_capgains = saleprice - price2;

	let qual_discount = Math.max(Math.min(saleprice - acq_price, discount * price1), 0);
	let qual_capgains = saleprice - (acq_price + qual_discount);

	let ltcg_begin = 12 + offlen;
	let ltcg_end = Math.max(24, ltcg_begin);
	$('off_timeline_len').innerText = disp_months(offlen);
	if (ltcg_end > ltcg_begin) {
		let ltcg_len = ltcg_end - ltcg_begin;
		$('offering_period').style.width = (offlen * 10 / 3) + "%";
		$('stcg').style.width = "40%";
		$('ltcg').style.display = "table-cell";
		$('ltcg').style.width = (ltcg_len * 10 / 3) + "%";
		$('qualdist').style.width = "20%";

		$('ltcg_timeline_len').innerText = disp_months(ltcg_len);	
	} else {
		let tot = 18 + offlen;
		$('offering_period').style.width = (offlen * 100 / tot) + "%";
		$('stcg').style.width = (1200 / tot) + "%";
		$('ltcg').style.display = 'none';
		$('qualdist').style.width = (600 / tot) + "%";
	}

	let disq_length = disp_months(ltcg_end - offlen);
	$('disq_len').innerText = disq_length;
	let ltcg_desc = "n/a - you cannot do this under your plan";
	if (ltcg_end > ltcg_begin) {
		ltcg_desc = "You sell between 1 year and " + disq_length + " after receiving the shares";
	}
	$('ltcg_desc').innerText = ltcg_desc;

	let ord1 = dispmoney(acq_price);
	$('ord1').innerHTML = ord1;
	// $('stcg_ord1').innerText = ord1;
	// $('ltcg_ord1').innerText = ord1;
	// $('qual_ord1').innerText = ord1;

	let disq_ord2 = dispmoney(disq_discount);
	$('stcg_ord2').innerHTML = disq_ord2;
	if (ltcg_end > ltcg_begin) {
		$('ltcg_ord2').innerHTML = disq_ord2;
	} else {
		$('ltcg_ord2').innerText = '';
	}
	$('qual_ord2').innerHTML = dispmoney(qual_discount);

	let disq_ord = dispmoney(acq_price + disq_discount);
	$('stcg_ord').innerHTML = disq_ord;
	if (ltcg_end > ltcg_begin) {
		$('ltcg_ord').innerHTML = disq_ord;
	} else {
		$('ltcg_ord').innerText = '';
	}
	$('qual_ord').innerHTML = dispmoney(acq_price + qual_discount);

	let disq_cg = dispmoney(disq_capgains);
	$('stcg_cg').innerHTML = disq_cg;
	if (ltcg_end > ltcg_begin) {
		$('ltcg_cg').innerHTML = disq_cg;
		$('ltcg_cg_outer').style.visibility = 'visible';
	} else {
		$('ltcg_cg_outer').style.visibility = 'hidden';
	}
	$('qual_cg').innerHTML = dispmoney(qual_capgains);
}
function bound_calculate() {
	if ($('lock').checked) {
		$('saleprice').disabled = true;
		$('saleprice').value = $('price2').value;
	} else {
		$('saleprice').disabled = false;
	}
	calculate(
		$('lookback').checked,
		parseInt($('offlen').value),
		parseInt($('discount').value)/100,
		parseFloat($('price1').value),
		parseFloat($('price2').value),
		parseFloat($('saleprice').value));
}
[$('lookback'), $('offlen'), $('discount'), $('price1'), $('price2'), $('saleprice'), $('lock')].forEach(elem => elem.addEventListener('change', bound_calculate));
</script>